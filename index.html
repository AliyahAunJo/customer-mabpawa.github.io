<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการข้อมูลแว่นตา</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        #modal { display: none; }
        #modal:not(.hidden) { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            z-index: 1000; 
        }
        #modal .modal-content { 
            max-height: 80vh; 
            overflow-y: auto; 
            width: 100%; 
            max-width: 1000px; 
            margin: 1rem; 
        }
        #preloader { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: white; 
            z-index: 9999; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .checkbox-group { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 1rem; 
        }
        .checkbox-group label { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }
        .radio-group { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 1rem; 
        }
        .radio-group label { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }
        .pagination button {
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
        }
        .pagination select {
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        .search-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .readonly-field {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        /* สีพื้นหลังและกรอบตารางข้อมูลลูกค้าเป็นสีชมพูพาสเทล */
        .customer-table-container {
            border: 2px solid #FFE4E1; /* ชมพูพาสเทลอ่อน */
            border-radius: 0.5rem;
            background-color: #FFF1F2; /* ชมพูพาสเทลอ่อน */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* สีพื้นหลังและขอบหัวข้อหลักใน Modal */
        .modal-content h3, .modal-content h4 {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem; /* ขอบมน */
            margin-bottom: 0.5rem;
            border: 1px solid;
        }
        /* ข้อมูลสมาชิก */
        .modal-content h3:nth-child(1) {
            background-color: #E0F2FE; /* ฟ้าอ่อนพาสเทล */
            border-color: #7DD3FC; /* ขอบฟ้าเข้มกว่า */
        }
        /* ข้อมูลลูกค้า */
        .modal-content h3:nth-child(3) {
            background-color: #DCFCE7; /* เขียวอ่อนพาสเทล */
            border-color: #86EFAC; /* ขอบเขียวเข้มกว่า */
        }
        /* O.D[R] */
        .modal-content h3:nth-child(5) {
            background-color: #F3E8FF; /* ม่วงอ่อนพาสเทล */
            border-color: #D8B4FE; /* ขอบม่วงเข้มกว่า */
        }
        /* O.D[L] */
        .modal-content h3:nth-child(7) {
            background-color: #FEF9C3; /* เหลืองอ่อนพาสเทล */
            border-color: #FDE68A; /* ขอบเหลืองเข้มกว่า */
        }
        /* ข้อมูลเลนส์ */
        .modal-content h3:nth-child(9) {
            background-color: #FFEDD5; /* ส้มอ่อนพาสเทล */
            border-color: #FDBA74; /* ขอบส้มเข้มกว่า */
        }
        /* Primary Rx */
        .modal-content h3:nth-child(11) {
            background-color: #D1FAE5; /* มินต์อ่อนพาสเทล */
            border-color: #6EE7B7; /* ขอบมินต์เข้มกว่า */
        }
        /* โครงสร้างแว่น */
        .modal-content h3:nth-child(13) {
            background-color: #FEE2E2; /* แดงอ่อนพาสเทล */
            border-color: #FCA5A5; /* ขอบแดงเข้มกว่า */
        }
        /* รายการแว่น */
        .modal-content h3:nth-child(15) {
            background-color: #FCE7F3; /* ชมพูอ่อนพาสเทล */
            border-color: #F9A8D4; /* ขอบชมพูเข้มกว่า */
        }
        /* หัวข้อย่อยใน Primary Rx และ โครงสร้างแว่น */
        .modal-content h4:nth-child(2) { /* Material Index */
            background-color: #E0F2FE;
            border-color: #7DD3FC;
        }
        .modal-content h4:nth-child(4) { /* Option */
            background-color: #DCFCE7;
            border-color: #86EFAC;
        }
        .modal-content h4:nth-child(6) { /* Lens Design */
            background-color: #F3E8FF;
            border-color: #D8B4FE;
        }
        .modal-content h4:nth-child(8) { /* ทำสี (Tint) */
            background-color: #FEF9C3;
            border-color: #FDE68A;
        }
        .modal-content h4:nth-child(10) { /* Treatment (เคลือบ) */
            background-color: #FFEDD5;
            border-color: #FDBA74;
        }
        .modal-content h4:nth-child(12) { /* Wear Type */
            background-color: #D1FAE5;
            border-color: #6EE7B7;
        }
        .modal-content h4:nth-child(14) { /* ลักษณะเข้ากรอบ */
            background-color: #FEE2E2;
            border-color: #FCA5A5;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="preloader">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold text-center mb-6 text-blue-600">ระบบจัดการข้อมูลแว่นตา</h1>

        <!-- Modal -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
            <div class="modal-content bg-white p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-4" id="modalTitle">บันทึกข้อมูลลูกค้า</h2>
                <form id="customerForm">
                    <input type="hidden" name="id">
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-2">ข้อมูลสมาชิก</h3>
                        <div class="radio-group">
                            <label><input type="radio" name="member_type" value="member"> ลูกค้าสมาชิก</label>
                            <label><input type="radio" name="member_type" value="new"> ลูกค้าใหม่</label>
                        </div>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-2">ข้อมูลลูกค้า</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium">วันเดือนปี</label>
                                <input type="text" id="birth_date" name="birth_date" class="flatpickr w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">ชื่อ</label>
                                <input type="text" name="first_name" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">สกุล</label>
                                <input type="text" name="last_name" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">อายุ</label>
                                <input type="number" name="age" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">เพศ</label>
                                <select name="gender" class="w-full p-2 border rounded" required>
                                    <option value="male">ชาย</option>
                                    <option value="female">หญิง</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">หมายเลขโทรศัพท์</label>
                                <input type="tel" name="phone" class="w-full p-2 border rounded" required>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium">ที่อยู่</label>
                                <textarea name="address" class="w-full p-2 border rounded" rows="4" required></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-semibold mb-2">O.D[R]</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm">Sphere</label><input type="text" name="od_r_sphere" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">CYL</label><input type="text" name="od_r_cyl" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">AXIS</label><input type="text" name="od_r_axis" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">ADD</label><input type="text" name="od_r_add" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">DPD</label><input type="text" name="od_r_dpd" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">NPD</label><input type="text" name="od_r_npd" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">SegHT</label><input type="text" name="od_r_seght" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">Prism</label><input type="text" name="od_r_prism" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">MONO-VA</label><input type="text" name="od_r_mono_va" class="w-full p-2 border rounded"></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-2">O.D[L]</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm">Sphere</label><input type="text" name="od_l_sphere" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">CYL</label><input type="text" name="od_l_cyl" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">AXIS</label><input type="text" name="od_l_axis" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">ADD</label><input type="text" name="od_l_add" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">DPD</label><input type="text" name="od_l_dpd" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">NPD</label><input type="text" name="od_l_npd" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">SegHT</label><input type="text" name="od_l_seght" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">Prism</label><input type="text" name="od_l_prism" class="w-full p-2 border rounded"></div>
                                <div><label class="block text-sm">MONO-VA</label><input type="text" name="od_l_mono_va" class="w-full p-2 border rounded"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-2">ข้อมูลเลนส์</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm">VA Both eyes (OU)</label><input type="text" name="va_both_eyes" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">เลนส์เดิม R</label><input type="text" name="lens_old_r" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">เลนส์เดิม L</label><input type="text" name="lens_old_l" class="w-full p-2 border rounded"></div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-2">Primary Rx</h3>
                        <div class="mb-4">
                            <h4 class="text-lg font-medium">Material Index</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="material_index" value="CR39"> CR39</label>
                                <label><input type="checkbox" name="material_index" value="1.56"> 1.56</label>
                                <label><input type="checkbox" name="material_index" value="1.6"> 1.6</label>
                                <label><input type="checkbox" name="material_index" value="1.67"> 1.67</label>
                                <label><input type="checkbox" name="material_index" value="1.74"> 1.74</label>
                                <label><input type="checkbox" name="material_index" value="PC"> PC</label>
                                <label><input type="checkbox" name="material_index" value="HIVEX"> HIVEX</label>
                                <label><input type="checkbox" name="material_index" value="Other"> Other</label>
                                <input type="text" name="material_index_other" class="w-full p-2 border rounded" placeholder="ระบุอื่นๆ">
                            </div>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-lg font-medium">Option</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="lens_option" value="Clear Lens"> Clear Lens</label>
                                <label><input type="checkbox" name="lens_option" value="UV420"> UV420</label>
                                <label><input type="checkbox" name="lens_option" value="Photochromic"> Photochromic</label>
                                <label><input type="checkbox" name="lens_option" value="Transition"> Transition</label>
                                <label><input type="checkbox" name="lens_option" value="Other"> Other</label>
                                <input type="text" name="lens_option_other" class="w-full p-2 border rounded" placeholder="ระบุอื่นๆ">
                            </div>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-lg font-medium">Lens Design</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="lens_design" value="Single Vision"> Single Vision</label>
                                <label><input type="checkbox" name="lens_design" value="Bifocal"> Bifocal</label>
                                <label><input type="checkbox" name="lens_design" value="Trifocal"> Trifocal</label>
                                <label><input type="checkbox" name="lens_design" value="Progressive"> Progressive</label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Lens Type</label>
                            <textarea name="lens_type" class="w-full p-2 border rounded" rows="3"></textarea>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-lg font-medium">ทำสี (Tint)</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="tint" value="Original"> เดิม</label>
                                <label><input type="checkbox" name="tint" value="Gradient"> ไล่สี</label>
                                <input type="text" name="tint_color" class="w-full p-2 border rounded" placeholder="ระบุสี">
                            </div>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-lg font-medium">Treatment (เคลือบ)</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="treatment" value="UC"> UC</label>
                                <label><input type="checkbox" name="treatment" value="HC"> HC</label>
                                <label><input type="checkbox" name="treatment" value="HMC"> HMC</label>
                                <label><input type="checkbox" name="treatment" value="SuperHMC"> SuperHMC</label>
                            </div>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-lg font-medium">Wear Type</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="wear_type" value="Full Time"> ตลอดเวลา</label>
                                <label><input type="checkbox" name="wear_type" value="Distance"> มองไกล</label>
                                <label><input type="checkbox" name="wear_type" value="Near"> มองใกล้</label>
                                <label><input type="checkbox" name="wear_type" value="Computer"> ระยะคอมพิวเตอร์</label>
                                <label><input type="checkbox" name="wear_type" value="Sunglasses"> กันแดด</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-2">โครงสร้างแว่น</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm">BVD</label><input type="text" name="bvd" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">PTA</label><input type="text" name="pta" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">Wrap</label><input type="text" name="wrap" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">BCL</label><input type="text" name="bcl" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">คาน</label><input type="text" name="frame_bridge" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">สูง</label><input type="text" name="frame_height" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">กว้าง</label><input type="text" name="frame_width" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ทะแยง</label><input type="text" name="frame_diagonal" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="mt-4">
                            <h4 class="text-lg font-medium">ลักษณะเข้ากรอบ</h4>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="frame_type" value="Full"> เต็ม</label>
                                <label><input type="checkbox" name="frame_type" value="Groove"> เซาะ</label>
                                <label><input type="checkbox" name="frame_type" value="Drill"> เจาะ</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-2">รายการแว่น</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm">ยี่ห้อแว่น</label><input type="text" name="frame_brand" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">รุ่น</label><input type="text" name="frame_model" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">หมายเหตุ</label><input type="text" name="notes" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ราคาแว่น</label><input type="number" name="frame_price" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ราคาเลนส์</label><input type="number" name="lens_price" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ส่วนลด</label><input type="number" name="discount" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ยอดรวม</label><input type="number" name="total" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ชำระ</label><input type="number" name="paid" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ผู้ตรวจสายตา</label><input type="text" name="examiner" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">ผู้สั่งซื้อ</label><input type="text" name="buyer" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm">คงค้าง</label><input type="number" name="outstanding" class="w-full p-2 border rounded"></div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" id="closeModalBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">ยกเลิก</button>
                        <button type="submit" id="submitBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div><canvas id="genderChart"></canvas></div>
            <div><canvas id="memberTypeChart"></canvas></div>
            <div><canvas id="totalRecordsChart"></canvas></div>
            <div><canvas id="ageRangeChart"></canvas></div>
        </div>

        <!-- Data Table -->
        <div class="customer-table-container p-6">
            <h2 class="text-2xl font-bold mb-4">รายการข้อมูลลูกค้า</h2>
            <div class="flex gap-4 mb-6 search-group">
                <button id="openModalBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                    เพิ่มข้อมูลลูกค้า
                </button>
                <input type="text" id="searchInput" class="w-full max-w-md p-2 border rounded" placeholder="ค้นหาลูกค้า (ชื่อ, นามสกุล, เบอร์โทร, ที่อยู่)">
                <button id="searchBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">ค้นหา</button>
            </div>
            <table class="w-full table-auto">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="px-4 py-2">ชื่อ</th>
                        <th class="px-4 py-2">สกุล</th>
                        <th class="px-4 py-2">เพศ</th>
                        <th class="px-4 py-2">ประเภทสมาชิก</th>
                        <th class="px-4 py-2">การดำเนินการ</th>
                    </tr>
                </thead>
                <tbody id="customerTable"></tbody>
            </table>
            <div class="pagination">
                <div>
                    <span>แสดง </span>
                    <select id="pageSizeSelect">
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span> รายการต่อหน้า</span>
                </div>
                <div>
                    <button id="prevPageBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold disabled:opacity-50" disabled>ก่อนหน้า</button>
                    <span id="pageInfo"></span>
                    <button id="nextPageBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold disabled:opacity-50" disabled>ถัดไป</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ดึง environment variable ใหม่จาก Supabase
        let SUPABASE_FUNCTIONS_URL = process.env.CUSTOMER_WEB || 'https://mihtvcbzguzkvfwnlnem.supabase.co/functions/v1/customer-web';
        let genderChart, memberTypeChart, totalRecordsChart, ageRangeChart;
        let currentPage = 1;
        let pageSize = 20;
        let totalRecords = 0;
        let searchQuery = '';

        flatpickr("#birth_date", {
            dateFormat: "Y-m-d",
            locale: {
                firstDayOfWeek: 1,
                weekdays: { shorthand: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'], longhand: ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'] },
                months: { shorthand: ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'], longhand: ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'] }
            }
        });

        function openModal(isView = false, id = null) {
            const modal = document.getElementById('modal');
            const form = document.getElementById('customerForm');
            const title = document.getElementById('modalTitle');
            const submitBtn = document.getElementById('submitBtn');
            const closeBtn = document.getElementById('closeModalBtn');
            modal.classList.remove('hidden');
            form.reset();
            form.querySelector('[name="id"]').value = ''; // Ensure id is cleared
            title.textContent = isView ? 'ดูข้อมูลลูกค้า' : 'บันทึกข้อมูลลูกค้า';
            submitBtn.style.display = isView ? 'none' : 'inline-block';
            closeBtn.textContent = isView ? 'ปิด' : 'ยกเลิก';
            form.onsubmit = isView ? (e) => e.preventDefault() : handleFormSubmit;

            // Set fields to read-only for view mode
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.readOnly = isView;
                input.disabled = isView;
                if (isView) {
                    input.classList.add('readonly-field');
                } else {
                    input.classList.remove('readonly-field');
                }
            });

            flatpickr("#birth_date", {
                dateFormat: "Y-m-d",
                locale: {
                    firstDayOfWeek: 1,
                    weekdays: { shorthand: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'], longhand: ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'] },
                    months: { shorthand: ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.,', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.,', 'พ.ย.', 'ธ.ค.'], longhand: ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'] }
                },
                disableMobile: isView // Disable flatpickr interaction in view mode
            });

            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.disabled = isView;
                if (isView) {
                    checkbox.classList.add('readonly-field');
                } else {
                    checkbox.classList.remove('readonly-field');
                }
            });
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            const form = document.getElementById('customerForm');
            form.reset();
            form.querySelector('[name="id"]').value = ''; // Ensure id is cleared
            form.onsubmit = handleFormSubmit;
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.readOnly = false;
                input.disabled = false;
                input.classList.remove('readonly-field');
            });
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.disabled = false;
                checkbox.classList.remove('readonly-field');
            });
            document.getElementById('submitBtn').style.display = 'inline-block';
            document.getElementById('closeModalBtn').textContent = 'ยกเลิก';
        }

        async function makeRequest(payload) {
            try {
                console.log('Sending request to:', SUPABASE_FUNCTIONS_URL, 'with payload:', payload);
                const response = await fetch(SUPABASE_FUNCTIONS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP error ${response.status}: ${response.statusText}. Response: ${text.substring(0, 100)}...`);
                }
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Expected JSON, received ${contentType}: ${text.substring(0, 100)}...`);
                }
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                console.log('Request response:', data);
                return data;
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        async function loadData(page = currentPage, limit = pageSize, search = searchQuery) {
            Swal.fire({ title: 'กำลังโหลด...', didOpen: () => Swal.showLoading() });
            try {
                const payload = { method: 'GET', page, limit };
                if (search) payload.search = search;
                const { data, total } = await makeRequest(payload);
                totalRecords = total;
                Swal.close();
                displayData(data);
                updateCharts(data);
                updatePagination();
            } catch (error) {
                Swal.fire('เกิดข้อผิดพลาด!', `ไม่สามารถโหลดข้อมูล: ${error.message}`, 'error');
                console.error('Load data error:', error);
            }
        }

        function displayData(data) {
            const tableBody = document.getElementById('customerTable');
            tableBody.innerHTML = '';
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">ไม่พบข้อมูล</td></tr>';
                return;
            }
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.classList.add('border-b', 'hover:bg-gray-100', 'cursor-pointer');
                tr.innerHTML = `
                    <td class="border px-4 py-2">${item.first_name || ''}</td>
                    <td class="border px-4 py-2">${item.last_name || ''}</td>
                    <td class="border px-4 py-2">${item.gender === 'male' ? 'ชาย' : item.gender === 'female' ? 'หญิง' : ''}</td>
                    <td class="border px-4 py-2">${item.member_type === 'member' ? 'ลูกค้าสมาชิก' : item.member_type === 'new' ? 'ลูกค้าใหม่' : ''}</td>
                    <td class="border px-4 py-2">
                        <button class="view-btn bg-green-500 hover:bg-green-600 text-white py-1 px-2 rounded">ดูข้อมูล</button>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded">ลบ</button>
                    </td>
                `;
                tr.querySelector('.view-btn').addEventListener('click', () => viewCustomer(item.id));
                tr.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteCustomer(item.id);
                });
                tableBody.appendChild(tr);
            });
        }

        function updatePagination() {
            const totalPages = Math.ceil(totalRecords / pageSize);
            document.getElementById('pageInfo').textContent = `หน้า ${currentPage} จาก ${totalPages}`;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalRecords === 0;
        }

        function updateCharts(data) {
            const genderCounts = { male: 0, female: 0 };
            const memberCounts = { member: 0, new: 0 };
            const ageRanges = { '0-20': 0, '21-40': 0, '41-60': 0, '61+': 0 };

            data.forEach(item => {
                if (item.gender) genderCounts[item.gender]++;
                if (item.member_type === 'member') memberCounts.member++;
                if (item.member_type === 'new') memberCounts.new++;
                if (item.age) {
                    if (item.age <= 20) ageRanges['0-20']++;
                    else if (item.age <= 40) ageRanges['21-40']++;
                    else if (item.age <= 60) ageRanges['41-60']++;
                    else ageRanges['61+']++;
                }
            });

            if (genderChart) genderChart.destroy();
            if (memberTypeChart) memberTypeChart.destroy();
            if (totalRecordsChart) totalRecordsChart.destroy();
            if (ageRangeChart) ageRangeChart.destroy();

            genderChart = new Chart(document.getElementById('genderChart'), {
                type: 'doughnut',
                data: {
                    labels: ['ชาย', 'หญิง'],
                    datasets: [{ data: [genderCounts.male, genderCounts.female], backgroundColor: ['#3B82F6', '#EC4899'] }]
                },
                options: { plugins: { title: { display: true, text: 'สัดส่วนเพศ' } } }
            });

            memberTypeChart = new Chart(document.getElementById('memberTypeChart'), {
                type: 'doughnut',
                data: {
                    labels: ['ลูกค้าสมาชิก', 'ลูกค้าใหม่'],
                    datasets: [{ data: [memberCounts.member, memberCounts.new], backgroundColor: ['#10B981', '#F59E0B'] }]
                },
                options: { plugins: { title: { display: true, text: 'ประเภทสมาชิก' } } }
            });

            totalRecordsChart = new Chart(document.getElementById('totalRecordsChart'), {
                type: 'doughnut',
                data: {
                    labels: ['จำนวนทั้งหมด'],
                    datasets: [{ data: [totalRecords], backgroundColor: ['#6366F1'] }]
                },
                options: { plugins: { title: { display: true, text: 'จำนวนทั้งหมด' } } }
            });

            ageRangeChart = new Chart(document.getElementById('ageRangeChart'), {
                type: 'doughnut',
                data: {
                    labels: ['0-20', '21-40', '41-60', '61+'],
                    datasets: [{ data: Object.values(ageRanges), backgroundColor: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6'] }]
                },
                options: { plugins: { title: { display: true, text: 'ช่วงอายุ' } } }
            });
        }

        function prepareFormData(formData) {
            const data = Object.fromEntries(formData);
            const arrayFields = ['frame_type', 'material_index', 'lens_option', 'lens_design', 'tint', 'treatment', 'wear_type'];
            arrayFields.forEach(field => {
                data[field] = formData.getAll(field).filter(val => val !== 'Other');
                if (data[field].length === 0) data[field] = null; // Supabase expects null for empty arrays
            });

            // Handle "Other" fields
            if (data.material_index_other) {
                if (data.material_index) {
                    data.material_index.push(data.material_index_other);
                } else {
                    data.material_index = [data.material_index_other];
                }
            }
            if (data.lens_option_other) {
                if (data.lens_option) {
                    data.lens_option.push(data.lens_option_other);
                } else {
                    data.lens_option = [data.lens_option_other];
                }
            }
            delete data.material_index_other;
            delete data.lens_option_other;

            // Convert numeric fields
            ['age', 'frame_price', 'lens_price', 'discount', 'total', 'paid', 'outstanding'].forEach(key => {
                data[key] = data[key] ? parseFloat(data[key]) : null;
            });

            // Ensure optional fields are null if empty
            ['birth_date', 'phone', 'address', 'od_r_sphere', 'od_r_cyl', 'od_r_axis', 'od_r_add', 'od_r_dpd', 'od_r_npd', 'od_r_seght', 'od_r_prism', 'od_r_mono_va', 'od_l_sphere', 'od_l_cyl', 'od_l_axis', 'od_l_add', 'od_l_dpd', 'od_l_npd', 'od_l_seght', 'od_l_prism', 'od_l_mono_va', 'va_both_eyes', 'lens_old_r', 'lens_old_l', 'lens_type', 'tint_color', 'bvd', 'pta', 'wrap', 'bcl', 'frame_bridge', 'frame_height', 'frame_width', 'frame_diagonal', 'frame_brand', 'frame_model', 'notes', 'examiner', 'buyer'].forEach(key => {
                if (!data[key]) data[key] = null;
            });

            // Remove id to prevent duplicate key errors
            delete data.id;

            return data;
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            Swal.fire({ title: 'กำลังบันทึก...', didOpen: () => Swal.showLoading() });

            const formData = new FormData(e.target);
            const data = prepareFormData(formData);

            if (!data.first_name || !data.last_name || !data.member_type || !data.age || !data.gender || !data.phone || !data.address) {
                Swal.fire('เกิดข้อผิดพลาด!', 'กรุณากรอกข้อมูลที่จำเป็น: ชื่อ, นามสกุล, ประเภทสมาชิก, อายุ, เพศ, เบอร์โทร, ที่อยู่', 'error');
                submitBtn.disabled = false;
                return;
            }

            try {
                console.log('Submitting new record:', data);
                const result = await makeRequest({ method: 'POST', data });
                Swal.fire('สำเร็จ!', 'บันทึกข้อมูลเรียบร้อย', 'success');
                closeModal();
                loadData();
            } catch (error) {
                Swal.fire('เกิดข้อผิดพลาด!', `ไม่สามารถบันทึกข้อมูล: ${error.message}`, 'error');
                console.error('Form submission error:', error);
            } finally {
                submitBtn.disabled = false;
            }
        }

        async function viewCustomer(id) {
            if (!id || isNaN(id)) {
                Swal.fire('เกิดข้อผิดพลาด!', 'ID ไม่ถูกต้อง', 'error');
                console.error('Invalid ID:', id);
                return;
            }
            console.log('Viewing customer with ID:', id);
            try {
                const record = await makeRequest({ method: 'GET_BY_ID', id });
                if (!record) {
                    throw new Error('No record found for the given ID');
                }
                console.log('Fetched record for viewing:', record);
                openModal(true, id);
                const form = document.getElementById('customerForm');
                form.querySelector('[name="id"]').value = id;

                form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });

                Object.entries(record).forEach(([key, value]) => {
                    if (key === 'member_type') {
                        const input = form.querySelector(`input[name="member_type"][value="${value}"]`);
                        if (input) input.checked = true;
                    } else if (key === 'birth_date') {
                        const input = form.querySelector(`[name="${key}"]`);
                        if (input && value) {
                            input.value = value;
                            flatpickr("#birth_date", {
                                dateFormat: "Y-m-d",
                                defaultDate: value,
                                locale: {
                                    firstDayOfWeek: 1,
                                    weekdays: { shorthand: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'], longhand: ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'] },
                                    months: { shorthand: ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.',', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.,', 'พ.ย.', 'ธ.ค.'], longhand: ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'] }
                                },
                                disableMobile: true
                            });
                        }
                    } else if (key === 'material_index' || key === 'lens_option' || key === 'lens_design' || key === 'tint' || key === 'treatment' || key === 'wear_type' || key === 'frame_type') {
                        if (Array.isArray(value)) {
                            value.forEach(val => {
                                const input = form.querySelector(`input[name="${key}"][value="${val}"]`);
                                if (input) {
                                    input.checked = true;
                                } else if (val && (key === 'material_index' || key === 'lens_option')) {
                                    form.querySelector(`[name="${key}_other"]`).value = val;
                                }
                            });
                        }
                    } else {
                        const input = form.querySelector(`[name="${key}"]`);
                        if (input) input.value = value ?? '';
                    }
                });
            } catch (error) {
                Swal.fire('เกิดข้อผิดพลาด!', `ไม่สามารถโหลดข้อมูลลูกค้า: ${error.message}`, 'error');
                console.error('View customer error:', error);
            }
        }

        async function deleteCustomer(id) {
            Swal.fire({
                title: 'ยืนยันการลบ?',
                text: 'ข้อมูลนี้จะถูกลบอย่างถาวร',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        console.log('Deleting customer with ID:', id);
                        const result = await makeRequest({ method: 'DELETE', id });
                        Swal.fire('สำเร็จ!', 'ลบข้อมูลเรียบร้อย', 'success');
                        loadData();
                    } catch (error) {
                        Swal.fire('เกิดข้อผิดพลาด!', `ไม่สามารถลบข้อมูล: ${error.message}`, 'error');
                        console.error('Delete customer error:', error);
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');

            setTimeout(() => {
                document.getElementById('preloader').style.display = 'none';
                loadData();
            }, 1000);

            document.getElementById('openModalBtn').addEventListener('click', () => openModal());
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('customerForm').addEventListener('submit', handleFormSubmit);

            document.getElementById('searchBtn').addEventListener('click', () => {
                searchQuery = document.getElementById('searchInput').value.trim();
                currentPage = 1;
                loadData();
            });

            document.getElementById('prevPageBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadData();
                }
            });
            document.getElementById('nextPageBtn').addEventListener('click', () => {
                const totalPages = Math.ceil(totalRecords / pageSize);
                if (currentPage < totalPages) {
                    currentPage++;
                    loadData();
                }
            });
            document.getElementById('pageSizeSelect').addEventListener('change', (e) => {
                pageSize = parseInt(e.target.value);
                currentPage = 1;
                loadData();
            });
        });
    </script>
</body>
</html>
